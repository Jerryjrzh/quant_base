#!/usr/bin/env python3
"""
ä¸‰é˜¶æ®µäº¤æ˜“å†³ç­–æ”¯æŒç³»ç»Ÿ - å¿«é€Ÿå¯åŠ¨è„šæœ¬

è¿™ä¸ªè„šæœ¬æä¾›äº†ä¸€ä¸ªç®€åŒ–çš„å…¥å£ç‚¹ï¼Œç”¨äºå¿«é€Ÿä½“éªŒç³»ç»ŸåŠŸèƒ½ã€‚
é€‚åˆåˆæ¬¡ä½¿ç”¨æˆ–æ¼”ç¤ºç›®çš„ã€‚
"""

import os
import sys
import json
from datetime import datetime
from pathlib import Path

def setup_demo_environment():
    """è®¾ç½®æ¼”ç¤ºç¯å¢ƒ"""
    print("ğŸ”§ æ­£åœ¨è®¾ç½®æ¼”ç¤ºç¯å¢ƒ...")
    
    # åˆ›å»ºå¿…è¦çš„ç›®å½•
    dirs = ['analysis_cache', 'reports', 'logs', 'data']
    for dir_name in dirs:
        Path(dir_name).mkdir(exist_ok=True)
    
    # åˆ›å»ºç¤ºä¾‹æ ¸å¿ƒè§‚å¯Ÿæ± 
    demo_pool = [
        {
            "stock_code": "sh000001",
            "score": 0.85,
            "params": {
                "pre_entry_discount": 0.02,
                "moderate_stop": 0.05
            },
            "analysis_date": datetime.now().isoformat()
        },
        {
            "stock_code": "sz000001", 
            "score": 0.78,
            "params": {
                "pre_entry_discount": 0.015,
                "moderate_stop": 0.04
            },
            "analysis_date": datetime.now().isoformat()
        }
    ]
    
    with open('core_stock_pool.json', 'w', encoding='utf-8') as f:
        json.dump(demo_pool, f, indent=2, ensure_ascii=False)
    
    print("âœ… æ¼”ç¤ºç¯å¢ƒè®¾ç½®å®Œæˆ")


def show_demo_menu():
    """æ˜¾ç¤ºæ¼”ç¤ºèœå•"""
    menu = """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    å¿«é€Ÿå¯åŠ¨æ¼”ç¤ºèœå•                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

è¯·é€‰æ‹©è¦æ¼”ç¤ºçš„åŠŸèƒ½ï¼š

1. æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€
2. è¿è¡Œç¬¬ä¸€é˜¶æ®µ (æ·±åº¦æµ·é€‰ä¸å‚æ•°ä¼˜åŒ–) - æ¼”ç¤ºæ¨¡å¼
3. è¿è¡Œç¬¬äºŒé˜¶æ®µ (æ¯æ—¥éªŒè¯ä¸ä¿¡å·è§¦å‘) - æ¼”ç¤ºæ¨¡å¼  
4. è¿è¡Œç¬¬ä¸‰é˜¶æ®µ (ç»©æ•ˆè·Ÿè¸ªä¸åé¦ˆ) - æ¼”ç¤ºæ¨¡å¼
5. è¿è¡Œå®Œæ•´å·¥ä½œæµ - æ¼”ç¤ºæ¨¡å¼
6. æŸ¥çœ‹é…ç½®æ–‡ä»¶
7. æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯
0. é€€å‡º

æ³¨æ„ï¼šæ¼”ç¤ºæ¨¡å¼ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼Œä¸ä¼šè¿›è¡Œå®é™…çš„è‚¡ç¥¨åˆ†æã€‚
"""
    print(menu)


def demo_phase1():
    """æ¼”ç¤ºç¬¬ä¸€é˜¶æ®µ"""
    print("\nğŸ” æ¼”ç¤ºç¬¬ä¸€é˜¶æ®µï¼šæ·±åº¦æµ·é€‰ä¸å‚æ•°ä¼˜åŒ–")
    print("-" * 50)
    
    print("æ­£åœ¨æ¨¡æ‹Ÿæ‰¹é‡å‚æ•°ä¼˜åŒ–...")
    print("  âœ“ å¤„ç†è‚¡ç¥¨: sh000001 - å¾—åˆ†: 0.85")
    print("  âœ“ å¤„ç†è‚¡ç¥¨: sz000001 - å¾—åˆ†: 0.78") 
    print("  âœ“ å¤„ç†è‚¡ç¥¨: sz000002 - å¾—åˆ†: 0.65")
    print("  âœ— å¤„ç†è‚¡ç¥¨: sz000003 - å¾—åˆ†: 0.45 (ä½äºé˜ˆå€¼)")
    
    print("\nç­›é€‰ç»“æœ:")
    print("  - æ€»å¤„ç†è‚¡ç¥¨æ•°: 4")
    print("  - é«˜è´¨é‡è‚¡ç¥¨æ•°: 3")
    print("  - å¹³å‡å¾—åˆ†: 0.76")
    print("  - æ ¸å¿ƒè§‚å¯Ÿæ± å·²æ›´æ–°")
    
    print("\nâœ… ç¬¬ä¸€é˜¶æ®µæ¼”ç¤ºå®Œæˆ")


def demo_phase2():
    """æ¼”ç¤ºç¬¬äºŒé˜¶æ®µ"""
    print("\nğŸ“Š æ¼”ç¤ºç¬¬äºŒé˜¶æ®µï¼šæ¯æ—¥éªŒè¯ä¸ä¿¡å·è§¦å‘")
    print("-" * 50)
    
    print("æ­£åœ¨éªŒè¯æ ¸å¿ƒè§‚å¯Ÿæ± ä¸­çš„è‚¡ç¥¨...")
    print("  âœ“ sh000001: æ£€æµ‹åˆ°ä¹°å…¥ä¿¡å· (ç½®ä¿¡åº¦: 0.82)")
    print("  â—‹ sz000001: æ— æ–°ä¿¡å·")
    print("  âœ“ sz000002: æ£€æµ‹åˆ°å–å‡ºä¿¡å· (ç½®ä¿¡åº¦: 0.75)")
    
    print("\nç”Ÿæˆçš„äº¤æ˜“ä¿¡å·:")
    print("  1. sh000001 - ä¹°å…¥å»ºè®®")
    print("     å…¥åœºä»·ä½: 3.25")
    print("     æ­¢æŸä½: 3.09")
    print("     æ­¢ç›ˆä½: 3.58")
    print("")
    print("  2. sz000002 - å–å‡ºå»ºè®®")
    print("     å½“å‰ä»·ä½: 12.80")
    print("     å»ºè®®å–å‡ºä»·: 12.75")
    
    print("\nâœ… ç¬¬äºŒé˜¶æ®µæ¼”ç¤ºå®Œæˆ")
    print("ğŸ“„ äº¤æ˜“æŠ¥å‘Šå·²ç”Ÿæˆåˆ° reports/ ç›®å½•")


def demo_phase3():
    """æ¼”ç¤ºç¬¬ä¸‰é˜¶æ®µ"""
    print("\nğŸ“ˆ æ¼”ç¤ºç¬¬ä¸‰é˜¶æ®µï¼šç»©æ•ˆè·Ÿè¸ªä¸åé¦ˆ")
    print("-" * 50)
    
    print("æ­£åœ¨åˆ†æå†å²ä¿¡å·è¡¨ç°...")
    print("  âœ“ æ›´æ–°ç»©æ•ˆè®°å½•: 15æ¡")
    print("  âœ“ sh000001: è¿‘æœŸèƒœç‡ 75% (å†å²: 70%) - ä¿¡ä»»åº¦æå‡")
    print("  âœ— sz000003: è¿‘æœŸèƒœç‡ 30% (å†å²: 65%) - ä¿¡ä»»åº¦ä¸‹é™")
    
    print("\næ ¸å¿ƒè§‚å¯Ÿæ± è°ƒæ•´:")
    print("  â†‘ sh000001: è¯„çº§æå‡ (A â†’ A+)")
    print("  â†“ sz000003: è¯„çº§ä¸‹é™ (B â†’ C)")
    print("  âœ— sz000004: ç§»å‡ºè§‚å¯Ÿæ±  (è¿ç»­è¡¨ç°ä¸ä½³)")
    
    print("\nâœ… ç¬¬ä¸‰é˜¶æ®µæ¼”ç¤ºå®Œæˆ")


def demo_full_workflow():
    """æ¼”ç¤ºå®Œæ•´å·¥ä½œæµ"""
    print("\nğŸš€ æ¼”ç¤ºå®Œæ•´ä¸‰é˜¶æ®µå·¥ä½œæµ")
    print("=" * 60)
    
    demo_phase1()
    print("\n" + "="*30)
    demo_phase2() 
    print("\n" + "="*30)
    demo_phase3()
    
    print("\n" + "="*60)
    print("ğŸ‰ å®Œæ•´å·¥ä½œæµæ¼”ç¤ºå®Œæˆï¼")


def show_config():
    """æ˜¾ç¤ºé…ç½®æ–‡ä»¶å†…å®¹"""
    print("\nğŸ“‹ å½“å‰é…ç½®æ–‡ä»¶å†…å®¹:")
    print("-" * 50)
    
    if os.path.exists('workflow_config.json'):
        with open('workflow_config.json', 'r', encoding='utf-8') as f:
            config = json.load(f)
        
        print("ç¬¬ä¸€é˜¶æ®µé…ç½®:")
        print(f"  - å¯ç”¨: {config['phase1']['enabled']}")
        print(f"  - æ‰§è¡Œé¢‘ç‡: {config['phase1']['frequency_days']}å¤©")
        print(f"  - æœ€å¤§å¤„ç†è‚¡ç¥¨æ•°: {config['phase1']['max_stocks']}")
        
        print("\nç¬¬äºŒé˜¶æ®µé…ç½®:")
        print(f"  - å¯ç”¨: {config['phase2']['enabled']}")
        print(f"  - æ‰§è¡Œé¢‘ç‡: {config['phase2']['frequency_days']}å¤©")
        print(f"  - æ ¸å¿ƒæ± å¤§å°: {config['phase2']['core_pool_size']}")
        
        print("\nç¬¬ä¸‰é˜¶æ®µé…ç½®:")
        print(f"  - å¯ç”¨: {config['phase3']['enabled']}")
        print(f"  - è·Ÿè¸ªå¤©æ•°: {config['phase3']['tracking_days']}")
        print(f"  - ç»©æ•ˆé˜ˆå€¼: {config['phase3']['performance_threshold']}")
    else:
        print("âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œç³»ç»Ÿåˆå§‹åŒ–")


def show_help():
    """æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯"""
    help_text = """
ğŸ“š ç³»ç»Ÿå¸®åŠ©ä¿¡æ¯

1. ç³»ç»Ÿæ¦‚è¿°:
   è¿™æ˜¯ä¸€ä¸ªä¸‰é˜¶æ®µçš„äº¤æ˜“å†³ç­–æ”¯æŒç³»ç»Ÿï¼Œæ—¨åœ¨é€šè¿‡ç³»ç»ŸåŒ–çš„æ–¹æ³•
   ç­›é€‰å’Œè·Ÿè¸ªé«˜è´¨é‡çš„äº¤æ˜“æœºä¼šã€‚

2. ä¸‰ä¸ªé˜¶æ®µè¯´æ˜:
   
   ç¬¬ä¸€é˜¶æ®µ - æ·±åº¦æµ·é€‰ä¸å‚æ•°ä¼˜åŒ–:
   â€¢ å¯¹å¤§é‡è‚¡ç¥¨è¿›è¡Œå‚æ•°ä¼˜åŒ–
   â€¢ ç­›é€‰å‡ºé«˜è´¨é‡çš„è‚¡ç¥¨æ± 
   â€¢ ä¸ºæ¯åªè‚¡ç¥¨æ‰¾åˆ°æœ€ä¼˜å‚æ•°
   
   ç¬¬äºŒé˜¶æ®µ - æ¯æ—¥éªŒè¯ä¸ä¿¡å·è§¦å‘:
   â€¢ å¯¹æ ¸å¿ƒè§‚å¯Ÿæ± è¿›è¡Œå¿«é€ŸéªŒè¯
   â€¢ æ£€æµ‹æ–°çš„äº¤æ˜“ä¿¡å·
   â€¢ ç”Ÿæˆå…·ä½“çš„äº¤æ˜“å»ºè®®
   
   ç¬¬ä¸‰é˜¶æ®µ - ç»©æ•ˆè·Ÿè¸ªä¸åé¦ˆ:
   â€¢ è·Ÿè¸ªä¿¡å·çš„å®é™…è¡¨ç°
   â€¢ åŠ¨æ€è°ƒæ•´æ ¸å¿ƒè§‚å¯Ÿæ± 
   â€¢ æŒç»­ä¼˜åŒ–ç³»ç»Ÿæ•ˆæœ

3. æ–‡ä»¶è¯´æ˜:
   â€¢ workflow_config.json: ç³»ç»Ÿé…ç½®æ–‡ä»¶
   â€¢ core_stock_pool.json: æ ¸å¿ƒè§‚å¯Ÿæ± æ•°æ®
   â€¢ reports/: æ¯æ—¥äº¤æ˜“æŠ¥å‘Š
   â€¢ analysis_cache/: åˆ†æç»“æœç¼“å­˜

4. å®é™…ä½¿ç”¨:
   æ¼”ç¤ºå®Œæˆåï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿è¡Œå®é™…ç³»ç»Ÿ:
   python run_workflow.py --status    # æŸ¥çœ‹çŠ¶æ€
   python run_workflow.py --phase phase2  # è¿è¡Œç¬¬äºŒé˜¶æ®µ
   python run_workflow.py             # è¿è¡Œå®Œæ•´å·¥ä½œæµ
"""
    print(help_text)


def main():
    """ä¸»å‡½æ•°"""
    print("ğŸ¯ ä¸‰é˜¶æ®µäº¤æ˜“å†³ç­–æ”¯æŒç³»ç»Ÿ - å¿«é€Ÿå¯åŠ¨")
    print("=" * 60)
    
    # è®¾ç½®æ¼”ç¤ºç¯å¢ƒ
    setup_demo_environment()
    
    while True:
        show_demo_menu()
        
        try:
            choice = input("\nè¯·è¾“å…¥é€‰é¡¹ (0-7): ").strip()
            
            if choice == '0':
                print("\nğŸ‘‹ æ„Ÿè°¢ä½¿ç”¨ï¼")
                break
            elif choice == '1':
                # å¯¼å…¥å¹¶æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€
                try:
                    from workflow_manager import WorkflowManager
                    manager = WorkflowManager()
                    from run_workflow import show_system_status
                    show_system_status(manager)
                except ImportError:
                    print("\nğŸ“Š ç³»ç»ŸçŠ¶æ€ (æ¼”ç¤ºæ¨¡å¼)")
                    print("  - æ ¸å¿ƒè§‚å¯Ÿæ± : 2åªè‚¡ç¥¨")
                    print("  - æœ€åè¿è¡Œ: æ¼”ç¤ºæ¨¡å¼")
                    print("  - ç³»ç»ŸçŠ¶æ€: æ­£å¸¸")
                    
            elif choice == '2':
                demo_phase1()
            elif choice == '3':
                demo_phase2()
            elif choice == '4':
                demo_phase3()
            elif choice == '5':
                demo_full_workflow()
            elif choice == '6':
                show_config()
            elif choice == '7':
                show_help()
            else:
                print("âŒ æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°é€‰æ‹©")
                
        except KeyboardInterrupt:
            print("\n\nğŸ‘‹ ç”¨æˆ·ä¸­æ–­ï¼Œé€€å‡ºç¨‹åº")
            break
        except Exception as e:
            print(f"\nâŒ å‘ç”Ÿé”™è¯¯: {e}")
        
        input("\næŒ‰å›è½¦é”®ç»§ç»­...")


if __name__ == "__main__":
    main()