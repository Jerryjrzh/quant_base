# 系统整体流程图

## 🔄 系统总体架构流程

```mermaid
graph TB
    %% 用户入口
    A[用户启动] --> B{选择模式}
    
    %% 三种主要模式
    B --> C[工作流模式]
    B --> D[单次分析模式]
    B --> E[Web界面模式]
    
    %% 工作流模式
    C --> F[WorkflowManager]
    F --> G[Phase1: 深度海选]
    F --> H[Phase2: 每日验证]
    F --> I[Phase3: 绩效跟踪]
    
    %% 单次分析模式
    D --> J[直接策略分析]
    D --> K[回测验证]
    
    %% Web界面模式
    E --> L[Flask API服务]
    L --> M[实时数据分析]
    L --> N[交互式图表]
    
    %% 核心处理流程
    G --> O[数据处理层]
    H --> O
    I --> O
    J --> O
    K --> O
    M --> O
    
    O --> P[DataLoader]
    O --> Q[IndicatorCalculator]
    O --> R[StrategyEngine]
    
    P --> S[股票数据文件]
    Q --> T[技术指标计算]
    R --> U[策略信号生成]
    
    T --> V[MACD/KDJ/RSI]
    U --> W[交易信号]
    
    %% 结果输出
    W --> X[结果存储]
    W --> Y[报告生成]
    W --> Z[用户界面显示]
    
    %% 反馈循环
    Z --> AA[用户反馈]
    AA --> F
```

## 📊 三阶段工作流详细流程

### Phase 1: 深度海选与参数优化

```mermaid
graph TD
    A[Phase1 启动] --> B[加载系统配置]
    B --> C[获取股票列表]
    C --> D[检查执行频率]
    D --> E{是否需要执行?}
    
    E -->|否| F[跳过执行]
    E -->|是| G[开始深度海选]
    
    G --> H[并行加载股票数据]
    H --> I[参数优化处理]
    I --> J[策略效果评估]
    J --> K[胜率过滤]
    K --> L[质量评分]
    L --> M[生成核心观察池]
    
    M --> N[保存观察池数据]
    N --> O[更新执行状态]
    O --> P[生成阶段报告]
    
    %% 并行处理细节
    H --> H1[股票1数据]
    H --> H2[股票2数据]
    H --> H3[股票N数据]
    
    H1 --> I
    H2 --> I
    H3 --> I
    
    %% 参数优化细节
    I --> I1[MACD参数优化]
    I --> I2[KDJ参数优化]
    I --> I3[RSI参数优化]
    
    I1 --> J
    I2 --> J
    I3 --> J
```

### Phase 2: 每日验证与信号触发

```mermaid
graph TD
    A[Phase2 启动] --> B[加载核心观察池]
    B --> C[检查观察池状态]
    C --> D{观察池是否有效?}
    
    D -->|否| E[触发Phase1执行]
    D -->|是| F[开始每日验证]
    
    F --> G[加载观察池股票数据]
    G --> H[计算最新技术指标]
    H --> I[执行策略分析]
    I --> J[生成交易信号]
    
    J --> K[信号质量评估]
    K --> L[风险控制检查]
    L --> M[T+1规则验证]
    
    M --> N{信号是否有效?}
    N -->|是| O[生成交易建议]
    N -->|否| P[记录无效信号]
    
    O --> Q[保存交易信号]
    Q --> R[发送通知]
    R --> S[更新信号历史]
    
    P --> S
    S --> T[生成每日报告]
    
    %% 信号类型分支
    O --> O1[买入信号]
    O --> O2[卖出信号]
    O --> O3[持有信号]
    O --> O4[观察信号]
```

### Phase 3: 绩效跟踪与反馈

```mermaid
graph TD
    A[Phase3 启动] --> B[加载历史交易信号]
    B --> C[获取最新价格数据]
    C --> D[计算信号绩效]
    
    D --> E[收益率计算]
    D --> F[胜率统计]
    D --> G[风险指标计算]
    
    E --> H[绩效分析]
    F --> H
    G --> H
    
    H --> I[识别表现差的股票]
    I --> J[核心池动态调整]
    J --> K[参数反馈优化]
    
    K --> L[更新策略配置]
    L --> M[保存绩效数据]
    M --> N[生成绩效报告]
    
    %% 调整策略
    I --> I1[移除低效股票]
    I --> I2[降低权重]
    I --> I3[标记观察]
    
    J --> J1[添加新股票]
    J --> J2[调整仓位]
    J --> J3[更新评分]
```

## 🎯 策略分析流程

```mermaid
graph TD
    A[策略分析开始] --> B[加载股票数据]
    B --> C[数据质量检查]
    C --> D{数据是否有效?}
    
    D -->|否| E[记录错误并跳过]
    D -->|是| F[计算技术指标]
    
    F --> G[MACD计算]
    F --> H[KDJ计算]
    F --> I[RSI计算]
    F --> J[移动平均线计算]
    
    G --> K[策略条件判断]
    H --> K
    I --> K
    J --> K
    
    K --> L[TRIPLE_CROSS策略]
    K --> M[PRE_CROSS策略]
    K --> N[MACD_ZERO_AXIS策略]
    
    L --> O[信号强度计算]
    M --> O
    N --> O
    
    O --> P[胜率过滤]
    P --> Q{通过胜率过滤?}
    
    Q -->|否| R[过滤信号]
    Q -->|是| S[质量评分]
    
    S --> T[风险评估]
    T --> U[最终信号生成]
    
    U --> V[保存分析结果]
    V --> W[返回信号数据]
    
    %% 错误处理
    E --> X[错误日志记录]
    R --> Y[过滤日志记录]
```

## 🔄 回测系统流程

```mermaid
graph TD
    A[回测开始] --> B[加载历史数据]
    B --> C[设置回测参数]
    C --> D[初始化交易账户]
    
    D --> E[开始历史数据遍历]
    E --> F[当前日期数据]
    F --> G[执行策略分析]
    
    G --> H[生成交易信号]
    H --> I{是否有交易信号?}
    
    I -->|否| J[继续下一天]
    I -->|是| K[执行交易模拟]
    
    K --> L[买入操作]
    K --> M[卖出操作]
    K --> N[持有操作]
    
    L --> O[更新持仓]
    M --> O
    N --> O
    
    O --> P[计算当日收益]
    P --> Q[更新账户状态]
    Q --> R[记录交易历史]
    
    R --> S{是否到达结束日期?}
    S -->|否| J
    S -->|是| T[计算最终绩效]
    
    T --> U[收益率计算]
    T --> V[风险指标计算]
    T --> W[交易统计]
    
    U --> X[生成回测报告]
    V --> X
    W --> X
    
    X --> Y[保存回测结果]
    
    %% T+1规则处理
    K --> K1[T+1规则检查]
    K1 --> K2{当日买入是否可卖?}
    K2 -->|否| K3[延迟到次日]
    K2 -->|是| M
```

## 📱 Web界面交互流程

```mermaid
graph TD
    A[用户访问Web界面] --> B[加载主页面]
    B --> C[显示股票列表]
    C --> D[用户选择股票]
    
    D --> E[发送API请求]
    E --> F[Flask后端处理]
    F --> G[加载股票数据]
    
    G --> H[计算技术指标]
    H --> I[执行策略分析]
    I --> J[生成图表数据]
    
    J --> K[返回JSON响应]
    K --> L[前端接收数据]
    L --> M[ECharts图表渲染]
    
    M --> N[显示K线图]
    M --> O[显示技术指标]
    M --> P[显示交易信号]
    
    N --> Q[用户交互]
    O --> Q
    P --> Q
    
    Q --> R[缩放/平移操作]
    Q --> S[切换时间周期]
    Q --> T[选择其他股票]
    
    R --> M
    S --> E
    T --> D
    
    %% 实时更新
    Q --> U[定时刷新]
    U --> E
```

## 🔧 配置管理流程

```mermaid
graph TD
    A[系统启动] --> B[ConfigManager初始化]
    B --> C[加载默认配置]
    C --> D[检查配置文件]
    
    D --> E{配置文件存在?}
    E -->|否| F[创建默认配置文件]
    E -->|是| G[加载配置文件]
    
    F --> H[合并配置]
    G --> H
    
    H --> I[验证配置有效性]
    I --> J{配置是否有效?}
    
    J -->|否| K[使用默认值]
    J -->|是| L[应用配置]
    
    K --> M[记录警告日志]
    L --> N[配置就绪]
    M --> N
    
    N --> O[系统运行时]
    O --> P[配置更新请求]
    P --> Q[验证新配置]
    Q --> R[保存配置文件]
    R --> S[通知相关模块]
    
    %% 配置热更新
    S --> T[重新加载配置]
    T --> U[应用新配置]
    U --> O
```

## 📊 数据处理流程

```mermaid
graph TD
    A[数据请求] --> B[DataLoader接收]
    B --> C[检查缓存]
    C --> D{缓存命中?}
    
    D -->|是| E[返回缓存数据]
    D -->|否| F[加载原始数据]
    
    F --> G[确定文件路径]
    G --> H[读取数据文件]
    H --> I[数据格式解析]
    
    I --> J[数据清洗]
    J --> K[数据验证]
    K --> L{数据是否有效?}
    
    L -->|否| M[记录错误]
    L -->|是| N[数据标准化]
    
    N --> O[计算衍生字段]
    O --> P[更新缓存]
    P --> Q[返回处理后数据]
    
    %% 错误处理
    M --> R[返回空数据]
    
    %% 缓存管理
    P --> S[检查缓存大小]
    S --> T{缓存是否过大?}
    T -->|是| U[清理旧缓存]
    T -->|否| Q
    U --> Q
```

## 🎯 信号生成与过滤流程

```mermaid
graph TD
    A[信号生成开始] --> B[策略分析]
    B --> C[原始信号生成]
    C --> D[信号强度计算]
    
    D --> E[第一层过滤: 基础条件]
    E --> F{满足基础条件?}
    
    F -->|否| G[丢弃信号]
    F -->|是| H[第二层过滤: 胜率过滤]
    
    H --> I[查询历史胜率]
    I --> J{胜率达标?}
    
    J -->|否| K[标记为低质量]
    J -->|是| L[第三层过滤: 质量评分]
    
    L --> M[计算综合质量分]
    M --> N{质量分达标?}
    
    N -->|否| O[降级处理]
    N -->|是| P[第四层过滤: 风险控制]
    
    P --> Q[风险评估]
    Q --> R{风险可控?}
    
    R -->|否| S[风险警告]
    R -->|是| T[最终信号确认]
    
    T --> U[信号输出]
    
    %% 信号分级
    K --> V[低质量信号池]
    O --> W[中等质量信号池]
    U --> X[高质量信号池]
    
    %% 后续处理
    V --> Y[观察处理]
    W --> Z[谨慎处理]
    X --> AA[优先处理]
```

这些流程图详细展示了系统各个层面的处理逻辑，为开发者理解系统运行机制和进行问题排查提供了清晰的指导。每个流程都包含了错误处理和异常情况的处理路径，确保系统的健壮性和可靠性。