<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å®Œæ•´MACDæ˜¾ç¤ºæµ‹è¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.3.3/dist/echarts.min.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #chart-container { 
            width: 100%; 
            height: 700px; 
            border: 1px solid #ddd;
            margin-top: 20px;
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .feature-list {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
        }
        .feature-list h4 {
            margin-top: 0;
            color: #495057;
        }
        .feature-list ul {
            margin-bottom: 0;
        }
        .feature-list li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>å®Œæ•´MACDæ˜¾ç¤ºä¿®å¤æµ‹è¯•</h1>
        
        <div class="info">
            <h3>ä¿®å¤è¯´æ˜</h3>
            <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯•å®Œæ•´çš„MACDæŒ‡æ ‡æ˜¾ç¤ºæ•ˆæœã€‚ä¿®å¤åçš„MACDæŒ‡æ ‡åŒ…å«ä¸‰ä¸ªç»„ä»¶ï¼š</p>
            <ul>
                <li><strong>DIFçº¿ï¼ˆç»¿è‰²ï¼‰</strong>ï¼šå¿«é€Ÿç§»åŠ¨å¹³å‡çº¿ï¼Œåæ˜ çŸ­æœŸè¶‹åŠ¿</li>
                <li><strong>DEAçº¿ï¼ˆæ©™è‰²ï¼‰</strong>ï¼šæ…¢é€Ÿç§»åŠ¨å¹³å‡çº¿ï¼Œåæ˜ é•¿æœŸè¶‹åŠ¿</li>
                <li><strong>MACDæŸ±çŠ¶å›¾</strong>ï¼šDIF-DEAçš„å·®å€¼ï¼Œçº¢æŸ±è¡¨ç¤ºæ­£å€¼ï¼Œé’æŸ±è¡¨ç¤ºè´Ÿå€¼</li>
            </ul>
        </div>
        
        <div class="feature-list">
            <h4>ğŸ¯ ä¿®å¤å†…å®¹</h4>
            <ul>
                <li>âœ… åç«¯è®¡ç®—å®Œæ•´MACDæ•°æ®ï¼ˆDIFã€DEAã€MACDæŸ±çŠ¶å›¾ï¼‰</li>
                <li>âœ… APIå“åº”åŒ…å«æ‰€æœ‰MACDç»„ä»¶</li>
                <li>âœ… å‰ç«¯å›¾è¡¨æ˜¾ç¤ºMACDæŸ±çŠ¶å›¾</li>
                <li>âœ… æŸ±çŠ¶å›¾é¢œè‰²åŒºåˆ†ï¼ˆæ­£å€¼çº¢è‰²ï¼Œè´Ÿå€¼é’è‰²ï¼‰</li>
                <li>âœ… å›¾è¡¨å¸ƒå±€ä¼˜åŒ–ï¼Œç¡®ä¿MACDæœ‰è¶³å¤Ÿæ˜¾ç¤ºç©ºé—´</li>
            </ul>
        </div>
        
        <div id="status" class="status">æ­£åœ¨åŠ è½½æ•°æ®...</div>
        
        <div id="chart-container"></div>
    </div>

    <script>
        const myChart = echarts.init(document.getElementById('chart-container'));
        const statusDiv = document.getElementById('status');
        
        function updateStatus(message, type = 'info') {
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }
        
        function loadTestData() {
            updateStatus('æ­£åœ¨ä»åç«¯åŠ è½½æ•°æ®...', 'warning');
            
            // é¦–å…ˆå°è¯•ä»åç«¯APIåŠ è½½æ•°æ®
            fetch('http://localhost:5000/api/analysis/sz000001?strategy=MACD_ZERO_AXIS')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(chartData => {
                    if (chartData.error) {
                        throw new Error(chartData.error);
                    }
                    
                    updateStatus('åç«¯æ•°æ®åŠ è½½æˆåŠŸï¼Œæ­£åœ¨æ¸²æŸ“å›¾è¡¨...', 'success');
                    renderChart(chartData);
                })
                .catch(error => {
                    console.error('Backend API Error:', error);
                    updateStatus(`åç«¯APIåŠ è½½å¤±è´¥: ${error.message}ï¼Œå°è¯•ä½¿ç”¨æµ‹è¯•æ•°æ®...`, 'warning');
                    
                    // å¦‚æœåç«¯APIå¤±è´¥ï¼Œå°è¯•åŠ è½½æµ‹è¯•æ•°æ®
                    loadLocalTestData();
                });
        }
        
        function loadLocalTestData() {
            fetch('./test_complete_macd_api_response.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('æµ‹è¯•æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨');
                    }
                    return response.json();
                })
                .then(chartData => {
                    updateStatus('æµ‹è¯•æ•°æ®åŠ è½½æˆåŠŸï¼Œæ­£åœ¨æ¸²æŸ“å›¾è¡¨...', 'success');
                    renderChart(chartData);
                })
                .catch(error => {
                    updateStatus('æ— æ³•åŠ è½½ä»»ä½•æ•°æ®ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æˆ–æµ‹è¯•æ•°æ®æ–‡ä»¶', 'error');
                    console.error('Local data error:', error);
                });
        }
        
        function renderChart(chartData) {
            const dates = chartData.kline_data.map(item => item.date);
            const klineData = chartData.kline_data.map(item => [item.open, item.close, item.low, item.high]);
            
            // æŠ€æœ¯æŒ‡æ ‡æ•°æ®
            const ma13Data = chartData.indicator_data.map(item => item.ma13);
            const ma45Data = chartData.indicator_data.map(item => item.ma45);
            const difData = chartData.indicator_data.map(item => item.dif);
            const deaData = chartData.indicator_data.map(item => item.dea);
            const macdData = chartData.indicator_data.map(item => item.macd);  // æ–°å¢çš„MACDæŸ±çŠ¶å›¾æ•°æ®
            const kData = chartData.indicator_data.map(item => item.k);
            const dData = chartData.indicator_data.map(item => item.d);
            const jData = chartData.indicator_data.map(item => item.j);
            const rsi6Data = chartData.indicator_data.map(item => item.rsi6);
            const rsi12Data = chartData.indicator_data.map(item => item.rsi12);
            const rsi24Data = chartData.indicator_data.map(item => item.rsi24);
            
            // è®¡ç®—MACDæŒ‡æ ‡çš„åˆç†èŒƒå›´
            const allMacdValues = [...difData, ...deaData, ...macdData].filter(val => val !== null && val !== undefined);
            const macdMin = allMacdValues.length > 0 ? Math.min(...allMacdValues) * 1.2 : -1;
            const macdMax = allMacdValues.length > 0 ? Math.max(...allMacdValues) * 1.2 : 1;
            
            console.log('MACDæ•°æ®ç»Ÿè®¡:');
            console.log('- DIFæ•°æ®æ ·æœ¬:', difData.slice(-5));
            console.log('- DEAæ•°æ®æ ·æœ¬:', deaData.slice(-5));
            console.log('- MACDæ•°æ®æ ·æœ¬:', macdData.slice(-5));
            console.log('- Yè½´èŒƒå›´:', macdMin, 'to', macdMax);
            
            const option = {
                title: {
                    text: 'å®Œæ•´MACDæ˜¾ç¤ºæµ‹è¯• - SZ000001',
                    left: 'center',
                    textStyle: { fontSize: 16 }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' },
                    backgroundColor: 'rgba(50, 50, 50, 0.9)',
                    textStyle: { color: '#fff' },
                    formatter: function(params) {
                        let result = params[0].axisValue + '<br/>';
                        params.forEach(param => {
                            if (param.seriesName === 'MACD') {
                                const color = param.value >= 0 ? '#ff6b6b' : '#4ecdc4';
                                result += `<span style="color:${color}">â— ${param.seriesName}: ${param.value?.toFixed(4) || 'N/A'}</span><br/>`;
                            } else {
                                result += `<span style="color:${param.color}">â— ${param.seriesName}: ${param.value?.toFixed(4) || 'N/A'}</span><br/>`;
                            }
                        });
                        return result;
                    }
                },
                legend: {
                    data: ['Kçº¿', 'MA13', 'MA45', 'DIF', 'DEA', 'MACD', 'K', 'D', 'J', 'RSI6', 'RSI12', 'RSI24'],
                    top: 30,
                    textStyle: { fontSize: 12 }
                },
                grid: [
                    { left: '8%', right: '5%', top: '8%', height: '35%' },      // Kçº¿å’ŒMA
                    { left: '8%', right: '5%', top: '46%', height: '15%' },     // RSIæŒ‡æ ‡
                    { left: '8%', right: '5%', top: '64%', height: '15%' },     // KDJæŒ‡æ ‡
                    { left: '8%', right: '5%', top: '82%', height: '15%' }      // MACDæŒ‡æ ‡
                ],
                xAxis: [
                    { 
                        type: 'category', 
                        data: dates, 
                        gridIndex: 0,
                        axisLabel: { show: false }
                    },
                    { 
                        type: 'category', 
                        data: dates, 
                        gridIndex: 1,
                        axisLabel: { show: false }
                    },
                    { 
                        type: 'category', 
                        data: dates, 
                        gridIndex: 2,
                        axisLabel: { show: false }
                    },
                    { 
                        type: 'category', 
                        data: dates, 
                        gridIndex: 3,
                        axisLabel: { fontSize: 10 }
                    }
                ],
                yAxis: [
                    { 
                        gridIndex: 0,
                        scale: true,
                        axisLabel: { fontSize: 10 }
                    },
                    { 
                        gridIndex: 1, 
                        max: 100, 
                        min: 0,
                        axisLabel: { fontSize: 10 },
                        splitLine: { show: true, lineStyle: { color: '#f0f0f0' } }
                    },
                    { 
                        gridIndex: 2, 
                        max: 100, 
                        min: 0,
                        axisLabel: { fontSize: 10 },
                        splitLine: { show: true, lineStyle: { color: '#f0f0f0' } }
                    },
                    { 
                        gridIndex: 3,
                        scale: true,
                        min: macdMin,
                        max: macdMax,
                        axisLabel: { fontSize: 10 },
                        splitLine: { show: true, lineStyle: { color: '#f0f0f0' } }
                    }
                ],
                dataZoom: [
                    { 
                        type: 'inside', 
                        xAxisIndex: [0, 1, 2, 3],
                        start: 70,
                        end: 100
                    },
                    { 
                        show: true, 
                        xAxisIndex: [0, 1, 2, 3], 
                        type: 'slider', 
                        bottom: '0%',
                        height: 20,
                        start: 70,
                        end: 100,
                        handleStyle: { color: '#007bff' },
                        textStyle: { fontSize: 10 }
                    }
                ],
                series: [
                    {
                        name: 'Kçº¿',
                        type: 'candlestick',
                        data: klineData,
                        xAxisIndex: 0,
                        yAxisIndex: 0
                    },
                    {
                        name: 'MA13',
                        type: 'line',
                        data: ma13Data,
                        smooth: true,
                        symbol: 'none',
                        lineStyle: { width: 1, color: '#ff6b6b' },
                        xAxisIndex: 0,
                        yAxisIndex: 0
                    },
                    {
                        name: 'MA45',
                        type: 'line',
                        data: ma45Data,
                        smooth: true,
                        symbol: 'none',
                        lineStyle: { width: 1, color: '#4ecdc4' },
                        xAxisIndex: 0,
                        yAxisIndex: 0
                    },
                    {
                        name: 'RSI6',
                        type: 'line',
                        data: rsi6Data,
                        smooth: true,
                        symbol: 'none',
                        xAxisIndex: 1,
                        yAxisIndex: 1,
                        lineStyle: { color: '#ff6b6b' }
                    },
                    {
                        name: 'RSI12',
                        type: 'line',
                        data: rsi12Data,
                        smooth: true,
                        symbol: 'none',
                        xAxisIndex: 1,
                        yAxisIndex: 1,
                        lineStyle: { color: '#4ecdc4' }
                    },
                    {
                        name: 'RSI24',
                        type: 'line',
                        data: rsi24Data,
                        smooth: true,
                        symbol: 'none',
                        xAxisIndex: 1,
                        yAxisIndex: 1,
                        lineStyle: { color: '#45b7d1' }
                    },
                    {
                        name: 'K',
                        type: 'line',
                        data: kData,
                        smooth: true,
                        symbol: 'none',
                        xAxisIndex: 2,
                        yAxisIndex: 2,
                        lineStyle: { color: '#f39c12' }
                    },
                    {
                        name: 'D',
                        type: 'line',
                        data: dData,
                        smooth: true,
                        symbol: 'none',
                        xAxisIndex: 2,
                        yAxisIndex: 2,
                        lineStyle: { color: '#e74c3c' }
                    },
                    {
                        name: 'J',
                        type: 'line',
                        data: jData,
                        smooth: true,
                        symbol: 'none',
                        xAxisIndex: 2,
                        yAxisIndex: 2,
                        lineStyle: { color: '#9b59b6' }
                    },
                    {
                        name: 'DIF',
                        type: 'line',
                        data: difData,
                        smooth: true,
                        symbol: 'none',
                        xAxisIndex: 3,
                        yAxisIndex: 3,
                        lineStyle: { color: '#2ecc71', width: 2 }
                    },
                    {
                        name: 'DEA',
                        type: 'line',
                        data: deaData,
                        smooth: true,
                        symbol: 'none',
                        xAxisIndex: 3,
                        yAxisIndex: 3,
                        lineStyle: { color: '#e67e22', width: 2 }
                    },
                    {
                        name: 'MACD',
                        type: 'bar',
                        data: macdData,
                        xAxisIndex: 3,
                        yAxisIndex: 3,
                        itemStyle: {
                            color: function(params) {
                                return params.value >= 0 ? '#ff6b6b' : '#4ecdc4';
                            }
                        },
                        barWidth: '60%'
                    }
                ]
            };
            
            myChart.setOption(option, true);
            
            // ç»Ÿè®¡MACDæŸ±çŠ¶å›¾æ•°æ®
            const validMacdData = macdData.filter(val => val !== null && val !== undefined);
            const positiveBars = validMacdData.filter(val => val > 0).length;
            const negativeBars = validMacdData.filter(val => val < 0).length;
            const zeroBars = validMacdData.filter(val => val === 0).length;
            
            updateStatus(
                `å›¾è¡¨æ¸²æŸ“å®Œæˆï¼MACDæŸ±çŠ¶å›¾æ˜¾ç¤ºåœ¨åº•éƒ¨åŒºåŸŸã€‚` +
                `æ•°æ®ç»Ÿè®¡: ${positiveBars}ä¸ªçº¢æŸ±(æ­£å€¼), ${negativeBars}ä¸ªé’æŸ±(è´Ÿå€¼), ${zeroBars}ä¸ªé›¶å€¼`, 
                'success'
            );
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹æµ‹è¯•
        document.addEventListener('DOMContentLoaded', function() {
            loadTestData();
        });
    </script>
</body>
</html>