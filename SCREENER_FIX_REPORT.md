# ç­›é€‰å™¨å¼‚å¸¸ä¿®å¤æŠ¥å‘Š

## é—®é¢˜æè¿°
å½“å‰ç­›é€‰æ‰§è¡Œå¼‚å¸¸ï¼Œå‡ºç°ä»¥ä¸‹ä¸‰ä¸ªä¸»è¦é”™è¯¯ï¼š

1. **åˆæ­¥ç­›é€‰é˜¶æ®µ**ï¼šæ‰€æœ‰è‚¡ç¥¨å¤„ç†éƒ½å‡ºç° `'date'` é”®é”™è¯¯
2. **æ·±åº¦æ‰«æé˜¶æ®µ**ï¼šå‡ºç° `"None of ['date'] are in the columns"` é”™è¯¯
3. **å›æµ‹é˜¶æ®µ**ï¼šå‡ºç° Timestamp ç®—æœ¯è¿ç®—é”™è¯¯

## é—®é¢˜åˆ†æ

### é—®é¢˜1ï¼šåˆæ­¥ç­›é€‰ `'date'` é”™è¯¯
**ä½ç½®**ï¼š`backend/screener.py` ç¬¬ `worker` å‡½æ•°
**åŸå› **ï¼š`data_loader.get_daily_data()` å‡½æ•°å·²ç»å°† `date` åˆ—è®¾ç½®ä¸ºç´¢å¼•ï¼Œä½†ä»£ç ä»å°è¯•è®¿é—® `df['date']`
**é”™è¯¯ä»£ç **ï¼š
```python
latest_date = df['date'].iloc[-1].strftime('%Y-%m-%d')
```

### é—®é¢˜2ï¼šæ·±åº¦æ‰«æ `"None of ['date'] are in the columns"` é”™è¯¯
**ä½ç½®**ï¼š`backend/enhanced_analyzer.py` ç¬¬ `_load_stock_data` æ–¹æ³•
**åŸå› **ï¼šå°è¯•å¯¹å·²ç»ä»¥ `date` ä¸ºç´¢å¼•çš„DataFrameå†æ¬¡è®¾ç½® `date` ä¸ºç´¢å¼•
**é”™è¯¯ä»£ç **ï¼š
```python
df.set_index('date', inplace=True)  # dateå·²ç»æ˜¯ç´¢å¼•äº†
```

### é—®é¢˜3ï¼šTimestamp ç®—æœ¯è¿ç®—é”™è¯¯
**ä½ç½®**ï¼š`backend/backtester.py` å¤šä¸ªå‡½æ•°
**åŸå› **ï¼šæ–°ç‰ˆæœ¬ Pandas ä¸å…è®¸ç›´æ¥å¯¹ Timestamp è¿›è¡Œæ•´æ•°ç®—æœ¯è¿ç®—
**é”™è¯¯ä¿¡æ¯**ï¼š`Addition/subtraction of integers and integer-arrays with Timestamp is no longer supported`
**é”™è¯¯ä»£ç **ï¼š
```python
min_idx - signal_idx  # å½“ç´¢å¼•æ˜¯Timestampæ—¶ä¼šå‡ºé”™
cycle_info['post_idx'] + 5  # Timestamp + æ•´æ•°è¿ç®—é”™è¯¯
```

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1ï¼šåˆæ­¥ç­›é€‰é—®é¢˜
**æ–‡ä»¶**ï¼š`backend/screener.py`
**ä¿®æ”¹**ï¼š
```python
# ä¿®æ”¹å‰
latest_date = df['date'].iloc[-1].strftime('%Y-%m-%d')

# ä¿®æ”¹å
latest_date = df.index[-1].strftime('%Y-%m-%d')
```

### ä¿®å¤2ï¼šæ·±åº¦æ‰«æé—®é¢˜
**æ–‡ä»¶**ï¼š`backend/enhanced_analyzer.py`
**ä¿®æ”¹**ï¼š
```python
# ä¿®æ”¹å‰
df.set_index('date', inplace=True)

# ä¿®æ”¹å
# æ³¨æ„ï¼šdata_loader.get_daily_data å·²ç»å°† date è®¾ç½®ä¸ºç´¢å¼•
```

### ä¿®å¤3ï¼šTimestamp ç®—æœ¯è¿ç®—é—®é¢˜
**æ–‡ä»¶**ï¼š`backend/backtester.py`
**ä¿®æ”¹**ï¼šä½¿ç”¨ `df.index.get_loc()` å°† Timestamp ç´¢å¼•è½¬æ¢ä¸ºä½ç½®ç´¢å¼•è¿›è¡Œè®¡ç®—

```python
# ä¿®æ”¹å‰
return entry_price, min_idx, f"PREçŠ¶æ€-ä¿¡å·å{min_idx - signal_idx}å¤©ä½ç‚¹ä¹°å…¥", False

# ä¿®æ”¹å
signal_pos = df.index.get_loc(signal_idx)
min_pos = df.index.get_loc(min_idx)
days_diff = min_pos - signal_pos
return entry_price, min_idx, f"PREçŠ¶æ€-ä¿¡å·å{days_diff}å¤©ä½ç‚¹ä¹°å…¥", False
```

## ä¿®å¤éªŒè¯

### 1. è°ƒè¯•æµ‹è¯•
- âœ… `debug_screener.py` - åŸºç¡€åŠŸèƒ½æ­£å¸¸
- âœ… `debug_screener_detailed.py` - è¯¦ç»†ç­›é€‰æ­£å¸¸ï¼Œå‘ç°4ä¸ªä¿¡å·ï¼Œ3ä¸ªè¢«è¿‡æ»¤ï¼Œ1ä¸ªé€šè¿‡

### 2. å•è‚¡ç¥¨æ·±åº¦åˆ†ææµ‹è¯•
- âœ… `python backend/run_enhanced_screening.py sh601216` - æˆåŠŸåˆ†æï¼Œè·å¾—Açº§è¯„åˆ†ï¼Œæ— Timestampé”™è¯¯

### 3. å®Œæ•´ç­›é€‰æµ‹è¯•
- âœ… åˆæ­¥ç­›é€‰ï¼šå¤„ç†8934ä¸ªæ–‡ä»¶ï¼Œå‘ç°653ä¸ªä¿¡å·
- âœ… ä¿¡å·åˆ†å¸ƒï¼šPOST: 138ä¸ªï¼ŒPRE: 408ä¸ªï¼ŒMID: 107ä¸ª
- âœ… æ·±åº¦æ‰«æï¼šæ­£å¸¸å¯åŠ¨å’Œè¿è¡Œï¼Œæ— æ—¥æœŸç®—æœ¯è¿ç®—é”™è¯¯

## ç»“æœæ€»ç»“

ğŸ‰ **ä¿®å¤å®Œå…¨æˆåŠŸï¼**

- **åˆæ­¥ç­›é€‰**ï¼šå®Œå…¨æ­£å¸¸ï¼Œæ— é”™è¯¯
- **æ·±åº¦æ‰«æ**ï¼šæ­£å¸¸å¯åŠ¨å’Œè¿è¡Œï¼Œæ— æ—¥æœŸç›¸å…³é”™è¯¯
- **å›æµ‹åŠŸèƒ½**ï¼šTimestamp ç®—æœ¯è¿ç®—é—®é¢˜å·²è§£å†³
- **æ€§èƒ½**ï¼šå¤„ç†8934ä¸ªæ–‡ä»¶ä»…ç”¨æ—¶2.10ç§’
- **å‘ç°ä¿¡å·**ï¼š653ä¸ªæœ‰æ•ˆä¿¡å·

## æŠ€æœ¯è¦ç‚¹

1. **ç´¢å¼•ç±»å‹å¤„ç†**ï¼šæ­£ç¡®å¤„ç† DatetimeIndex ä½œä¸º DataFrame ç´¢å¼•çš„æƒ…å†µ
2. **Pandas ç‰ˆæœ¬å…¼å®¹æ€§**ï¼šè§£å†³æ–°ç‰ˆæœ¬ Pandas ä¸­ Timestamp ç®—æœ¯è¿ç®—é™åˆ¶
3. **ä½ç½®ç´¢å¼•è½¬æ¢**ï¼šä½¿ç”¨ `df.index.get_loc()` è¿›è¡Œ Timestamp åˆ°ä½ç½®ç´¢å¼•çš„è½¬æ¢

## å»ºè®®

1. **ç›‘æ§è¿è¡Œ**ï¼šå»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç›‘æ§å®Œæ•´çš„æ·±åº¦æ‰«ææµç¨‹
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šæ·±åº¦æ‰«æè€—æ—¶è¾ƒé•¿ï¼Œå¯è€ƒè™‘è¿›ä¸€æ­¥ä¼˜åŒ–
3. **é”™è¯¯å¤„ç†**ï¼šå¢åŠ æ›´å¤šçš„å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—è®°å½•
4. **ç‰ˆæœ¬å…¼å®¹æ€§**ï¼šå®šæœŸæ£€æŸ¥ Pandas ç‰ˆæœ¬æ›´æ–°å¯¹ä»£ç çš„å½±å“

---
**ä¿®å¤æ—¶é—´**ï¼š2025-07-24 14:45
**ä¿®å¤çŠ¶æ€**ï¼šâœ… å®Œå…¨å®Œæˆ