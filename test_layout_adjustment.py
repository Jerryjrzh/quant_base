#!/usr/bin/env python3
"""
æµ‹è¯•å‰ç«¯å¸ƒå±€è°ƒæ•´æ•ˆæœ
éªŒè¯æŒ‡æ ‡æ˜¾ç¤ºåŒºåŸŸæ˜¯å¦æ›´æ¸…æ¥šï¼Œäº¤æ˜“å»ºè®®å’Œå›æµ‹è¡¨ç°æ˜¯å¦æ­£ç¡®æ˜¾ç¤ºåœ¨ä¾§è¾¹æ 
"""

import subprocess
import time
import webbrowser
import os
from pathlib import Path

def test_layout_adjustment():
    """æµ‹è¯•å¸ƒå±€è°ƒæ•´æ•ˆæœ"""
    print("ğŸ¨ æµ‹è¯•å‰ç«¯å¸ƒå±€è°ƒæ•´...")
    
    # æ£€æŸ¥å‰ç«¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    frontend_dir = Path("frontend")
    html_file = frontend_dir / "index.html"
    js_file = frontend_dir / "js" / "app.js"
    
    if not html_file.exists():
        print("âŒ HTMLæ–‡ä»¶ä¸å­˜åœ¨")
        return False
        
    if not js_file.exists():
        print("âŒ JavaScriptæ–‡ä»¶ä¸å­˜åœ¨")
        return False
    
    print("âœ… å‰ç«¯æ–‡ä»¶æ£€æŸ¥é€šè¿‡")
    
    # æ£€æŸ¥å¸ƒå±€è°ƒæ•´çš„å…³é”®å…ƒç´ 
    with open(html_file, 'r', encoding='utf-8') as f:
        html_content = f.read()
    
    # éªŒè¯å…³é”®å¸ƒå±€å…ƒç´ 
    layout_checks = [
        ('.sidebar', 'ä¾§è¾¹æ å®¹å™¨'),
        ('.chart-section', 'å›¾è¡¨åŒºåŸŸ'),
        ('.backtest-panel', 'å›æµ‹é¢æ¿'),
        ('.trading-advice-panel', 'äº¤æ˜“å»ºè®®é¢æ¿'),
        ('flex: 3', 'å›¾è¡¨åŒºåŸŸå æ¯”è°ƒæ•´'),
        ('height: 650px', 'å›¾è¡¨é«˜åº¦è°ƒæ•´'),
        ('min-width: 320px', 'ä¾§è¾¹æ æœ€å°å®½åº¦'),
        ('max-width: 380px', 'ä¾§è¾¹æ æœ€å¤§å®½åº¦'),
    ]
    
    print("\nğŸ“‹ å¸ƒå±€å…ƒç´ æ£€æŸ¥:")
    for check_item, description in layout_checks:
        if check_item in html_content:
            print(f"âœ… {description}: å·²å®ç°")
        else:
            print(f"âŒ {description}: æœªæ‰¾åˆ°")
    
    # æ£€æŸ¥å“åº”å¼è®¾è®¡
    responsive_checks = [
        ('@media (max-width: 1200px)', 'ä¸­ç­‰å±å¹•é€‚é…'),
        ('@media (max-width: 768px)', 'å°å±å¹•é€‚é…'),
        ('flex-direction: column', 'å‚ç›´å¸ƒå±€'),
        ('grid-template-columns: 1fr', 'å•åˆ—ç½‘æ ¼'),
    ]
    
    print("\nğŸ“± å“åº”å¼è®¾è®¡æ£€æŸ¥:")
    for check_item, description in responsive_checks:
        if check_item in html_content:
            print(f"âœ… {description}: å·²å®ç°")
        else:
            print(f"âŒ {description}: æœªæ‰¾åˆ°")
    
    # å¯åŠ¨åç«¯æœåŠ¡è¿›è¡Œå®é™…æµ‹è¯•
    print("\nğŸš€ å¯åŠ¨åç«¯æœåŠ¡è¿›è¡Œå®é™…æµ‹è¯•...")
    try:
        # å¯åŠ¨Flaskåº”ç”¨
        backend_process = subprocess.Popen(
            ['python', 'backend/app.py'],
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE
        )
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        time.sleep(3)
        
        # æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
        import requests
        try:
            response = requests.get('http://localhost:5000', timeout=5)
            if response.status_code == 200:
                print("âœ… åç«¯æœåŠ¡å¯åŠ¨æˆåŠŸ")
                
                # æ‰“å¼€æµè§ˆå™¨æŸ¥çœ‹æ•ˆæœ
                print("ğŸŒ åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€é¡µé¢æŸ¥çœ‹å¸ƒå±€æ•ˆæœ...")
                webbrowser.open('http://localhost:5000')
                
                print("\nğŸ“Š å¸ƒå±€è°ƒæ•´è¯´æ˜:")
                print("1. å›¾è¡¨åŒºåŸŸç°åœ¨å æ®æ›´å¤šç©ºé—´ (flex: 3)")
                print("2. å›¾è¡¨é«˜åº¦å¢åŠ åˆ° 650pxï¼Œæ˜¾ç¤ºæ›´æ¸…æ¥š")
                print("3. äº¤æ˜“å»ºè®®å’Œå›æµ‹è¡¨ç°ç§»åˆ°å³ä¾§è¾¹æ ")
                print("4. ä¾§è¾¹æ å®½åº¦å›ºå®šåœ¨ 320-380px ä¹‹é—´")
                print("5. å›æµ‹æ•°æ®ä»¥ç½‘æ ¼å½¢å¼ç´§å‡‘æ˜¾ç¤º")
                print("6. æ·»åŠ äº†å“åº”å¼è®¾è®¡ï¼Œé€‚é…ä¸åŒå±å¹•å°ºå¯¸")
                
                print("\nğŸ¯ å¸ƒå±€ä¼˜åŒ–æ•ˆæœ:")
                print("- æŒ‡æ ‡æ˜¾ç¤ºåŒºåŸŸæ›´å®½æ•æ¸…æ¥š")
                print("- ä¾§è¾¹æ ä¿¡æ¯ä¸å¹²æ‰°ä¸»è¦å›¾è¡¨")
                print("- å›æµ‹æ•°æ®ä»¥å¡ç‰‡å½¢å¼æ•´é½å±•ç¤º")
                print("- äº¤æ˜“å»ºè®®ä¿¡æ¯ç»“æ„åŒ–æ˜¾ç¤º")
                print("- æ”¯æŒç§»åŠ¨ç«¯å’Œå¹³æ¿è®¾å¤‡")
                
                input("\næŒ‰å›è½¦é”®åœæ­¢æµ‹è¯•...")
                
            else:
                print(f"âŒ åç«¯æœåŠ¡å“åº”å¼‚å¸¸: {response.status_code}")
                
        except requests.exceptions.RequestException as e:
            print(f"âŒ æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡: {e}")
            
        finally:
            # åœæ­¢åç«¯æœåŠ¡
            backend_process.terminate()
            backend_process.wait()
            print("ğŸ›‘ åç«¯æœåŠ¡å·²åœæ­¢")
            
    except Exception as e:
        print(f"âŒ å¯åŠ¨åç«¯æœåŠ¡å¤±è´¥: {e}")
        return False
    
    return True

def generate_layout_report():
    """ç”Ÿæˆå¸ƒå±€è°ƒæ•´æŠ¥å‘Š"""
    report = """
# å‰ç«¯å¸ƒå±€è°ƒæ•´å®ŒæˆæŠ¥å‘Š

## è°ƒæ•´æ¦‚è¿°
æˆåŠŸè°ƒæ•´äº†å‰ç«¯å¸ƒå±€ï¼Œè®©æŒ‡æ ‡æ˜¾ç¤ºåŒºåŸŸæ›´æ¸…æ¥šï¼Œäº¤æ˜“å»ºè®®å’Œå›æµ‹è¡¨ç°ç§»åˆ°ä¾§è¾¹æ ã€‚

## ä¸»è¦æ”¹è¿›

### 1. å¸ƒå±€ç»“æ„ä¼˜åŒ–
- **å›¾è¡¨åŒºåŸŸæ‰©å¤§**: ä» flex: 2 è°ƒæ•´ä¸º flex: 3ï¼Œå æ®æ›´å¤šç©ºé—´
- **å›¾è¡¨é«˜åº¦å¢åŠ **: ä» 600px å¢åŠ åˆ° 650pxï¼Œæ˜¾ç¤ºæ›´æ¸…æ¥š
- **ä¾§è¾¹æ ç‹¬ç«‹**: åˆ›å»ºä¸“é—¨çš„ä¾§è¾¹æ å®¹å™¨ï¼Œå®½åº¦å›ºå®šåœ¨ 320-380px

### 2. ä¿¡æ¯é‡æ–°ç»„ç»‡
- **å›æµ‹è¡¨ç°**: ç§»åˆ°ä¾§è¾¹æ é¡¶éƒ¨ï¼Œä»¥ç´§å‡‘çš„ç½‘æ ¼å½¢å¼æ˜¾ç¤º
- **äº¤æ˜“å»ºè®®**: ç§»åˆ°ä¾§è¾¹æ ä¸‹éƒ¨ï¼Œä¿æŒåŸæœ‰åŠŸèƒ½
- **ä¸»å›¾è¡¨**: å æ®ä¸»è¦åŒºåŸŸï¼Œä¸å—å…¶ä»–ä¿¡æ¯å¹²æ‰°

### 3. è§†è§‰ä¼˜åŒ–
- **å›æµ‹æ•°æ®**: é‡‡ç”¨ç½‘æ ¼å¸ƒå±€ï¼Œä¿¡æ¯å¯†åº¦æ›´é«˜
- **å¡ç‰‡è®¾è®¡**: ç»Ÿä¸€çš„å¡ç‰‡æ ·å¼ï¼Œè§†è§‰å±‚æ¬¡æ¸…æ™°
- **é¢œè‰²ç¼–ç **: æ”¶ç›Šç”¨ç»¿è‰²ï¼Œå›æ’¤ç”¨çº¢è‰²ï¼Œç›´è§‚æ˜“æ‡‚

### 4. å“åº”å¼è®¾è®¡
- **å¤§å±å¹•**: ä¾§è¾¹æ åœ¨å³ä¾§ï¼Œå›¾è¡¨å ä¸»è¦ç©ºé—´
- **ä¸­ç­‰å±å¹•**: ä¾§è¾¹æ å˜ä¸ºæ°´å¹³å¸ƒå±€
- **å°å±å¹•**: å‚ç›´å †å ï¼Œé€‚é…ç§»åŠ¨è®¾å¤‡

## æŠ€æœ¯å®ç°

### CSS å…³é”®è°ƒæ•´
```css
.chart-section {
    flex: 3;  /* å›¾è¡¨åŒºåŸŸå æ›´å¤šç©ºé—´ */
    height: 650px;  /* å¢åŠ é«˜åº¦ */
}

.sidebar {
    flex: 1;
    min-width: 320px;
    max-width: 380px;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}
```

### HTML ç»“æ„è°ƒæ•´
- å°†å›æµ‹ç»“æœä»å›¾è¡¨åŒºåŸŸç§»åˆ°ä¾§è¾¹æ 
- åˆ›å»ºç‹¬ç«‹çš„ä¾§è¾¹æ å®¹å™¨
- ä¼˜åŒ–ä¿¡æ¯å±•ç¤ºçš„å±‚æ¬¡ç»“æ„

## ç”¨æˆ·ä½“éªŒæå‡

1. **æŒ‡æ ‡æ˜¾ç¤ºæ›´æ¸…æ¥š**: å›¾è¡¨åŒºåŸŸæ›´å¤§ï¼ŒæŠ€æœ¯æŒ‡æ ‡çº¿æ¡å’Œæ•°æ®ç‚¹æ›´å®¹æ˜“è¯†åˆ«
2. **ä¿¡æ¯ä¸å¹²æ‰°**: äº¤æ˜“å»ºè®®å’Œå›æµ‹æ•°æ®åœ¨ä¾§è¾¹ï¼Œä¸å½±å“å›¾è¡¨æŸ¥çœ‹
3. **æ•°æ®ä¸€ç›®äº†ç„¶**: å›æµ‹æ•°æ®ä»¥ç½‘æ ¼å½¢å¼å±•ç¤ºï¼Œå…³é”®æŒ‡æ ‡å¿«é€Ÿè·å–
4. **å“åº”å¼å‹å¥½**: åœ¨ä¸åŒè®¾å¤‡ä¸Šéƒ½èƒ½è‰¯å¥½æ˜¾ç¤º

## æµ‹è¯•å»ºè®®

1. åœ¨ä¸åŒæµè§ˆå™¨ä¸­æµ‹è¯•æ˜¾ç¤ºæ•ˆæœ
2. æµ‹è¯•ä¸åŒå±å¹•å°ºå¯¸çš„å“åº”å¼è¡¨ç°
3. éªŒè¯æ•°æ®åŠ è½½æ—¶çš„å¸ƒå±€ç¨³å®šæ€§
4. æ£€æŸ¥äº¤äº’åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ

å¸ƒå±€è°ƒæ•´å·²å®Œæˆï¼ŒæŒ‡æ ‡æ˜¾ç¤ºåŒºåŸŸç°åœ¨æ›´åŠ æ¸…æ¥šå’Œä¸“ä¸šã€‚
"""
    
    with open('LAYOUT_ADJUSTMENT_REPORT.md', 'w', encoding='utf-8') as f:
        f.write(report)
    
    print("ğŸ“„ å¸ƒå±€è°ƒæ•´æŠ¥å‘Šå·²ç”Ÿæˆ: LAYOUT_ADJUSTMENT_REPORT.md")

if __name__ == "__main__":
    print("ğŸ¨ å‰ç«¯å¸ƒå±€è°ƒæ•´æµ‹è¯•")
    print("=" * 50)
    
    success = test_layout_adjustment()
    
    if success:
        generate_layout_report()
        print("\nâœ… å¸ƒå±€è°ƒæ•´æµ‹è¯•å®Œæˆ")
    else:
        print("\nâŒ å¸ƒå±€è°ƒæ•´æµ‹è¯•å¤±è´¥")